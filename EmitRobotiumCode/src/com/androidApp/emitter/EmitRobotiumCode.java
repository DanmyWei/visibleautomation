package com.androidApp.emitter;

import java.io.BufferedWriter;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.util.ArrayList;
import java.util.Hashtable;
import java.util.List;
import java.util.Map.Entry;

import com.androidApp.emitter.IEmitCode.LineAndTokens;
import com.androidApp.parser.ProjectPropertiesScan;
import com.androidApp.savestate.SaveState;
import com.androidApp.savestate.SaveStateException;
import com.androidApp.util.Constants;
import com.androidApp.util.FileUtility;
import com.androidApp.util.StringUtils;

/** 
 * class to emit robotium code from the events.txt file generated by the recorder.
 * @author Matthew
 * Copyright (c) 2013 Visible Automation LLC.  All Rights Reserved.
 * TODO: All Events MUST respect mLastEventWasWaitForActivity, not just click
 * TODO: add mLastEventWasCreateDialog for the same thing
 */
public class EmitRobotiumCode {
	/**
	 * take an input file spit out by the event recorder, and generate robotium code
	 * @param args 4 strings: input file (events.txt), output file test.java, target project name and the robotiumJar file.
	 * the caller has to specify the project name because the .apk file name can be changed, and it actually the name of the 
	 * build project, i.e. made from unobtainium
	 * @throws FileNotFoundException if source files can't be found
	 * @throws IOException if source files can't be read
	 * @throws EmitterException if source files can't be parsed.
	 * @throws SaveStateException if save state files can't be copied from the device.
	 */
	public static void main(String[] args) throws FileNotFoundException, IOException, EmitterException, SaveStateException {
		if (args.length < 2) {
			System.err.println("usage: EmitRobotium [events.txt|device] [view_directives.txt|device|none] <target-project-name> [binary]");
			System.err.println("events.txt is the output file from the recorder");
			System.err.println("device pulls the events.txt file from /sdcard/events.txt");
			System.err.println("<target-project-name> is the name of the project to instrument via robotium");
			System.err.println("if \"device\" is specified, then it is the class path of the activity to instrument");
			System.err.println("if <target-project-name> directory exists, then the output code will be written into");
			System.err.println("a new file with a numeric suffix, e.g. ApiDemosTest1.java");
			System.err.println("<robotium-jar-path> path to the robotium jar file (download it from http://code.google.com/p/robotium/downloads/list)");
			System.err.println("--splitFunctions splits the output into functions bracketed by activities");
			System.err.println("--minLines <min-lines> minimum # of lines of code in a function (default: 5) ");
			System.exit(-1);
		}
		String eventsFileName = args[0];
		String viewDirectiveFileName = args[1];
		String targetProject = args[2];
		boolean fBinary = false;
		if (args.length == 3) {
			fBinary = args[2].equals("binary");
		}
		String outputCodeFileName = Constants.Filenames.OUTPUT;
		IEmitCode emitter = null;
		if (fBinary) {
			emitter = new EmitRobotiumCodeBinary();
		} else {
			emitter = new EmitRobotiumCodeSource();
		}
		SetupRobotiumProject setup = new SetupRobotiumProject();
		SetupRobotiumProject.Options options = setup.processOptions(args);
		
		// scan the project properties file
		File projectPropertiesFile = new File(targetProject,  Constants.Filenames.PROJECT_PROPERTIES_FILENAME);
		ProjectPropertiesScan projectPropertiesScan = null;
		try {
			projectPropertiesScan = new ProjectPropertiesScan(projectPropertiesFile);
		} catch (Exception ex) {
			ex.printStackTrace();
		}

		// grab the events file
		eventsFileName = SetupRobotiumProject.getEventsFile(eventsFileName);
		if (!viewDirectiveFileName.equals(Constants.Filenames.NONE)) {
			viewDirectiveFileName = SetupRobotiumProject.getViewDirectivesFile(viewDirectiveFileName);
		}
		
		// grab the 
		// generate the test code.
		List<MotionEventList> motionEvents = new ArrayList<MotionEventList>();
		Hashtable<String, List<LineAndTokens>> outputCode = emitter.generateTestCode(emitter, eventsFileName, motionEvents);
		List<LineAndTokens> mainCode = outputCode.get(Constants.MAIN);
		if (emitter.getApplicationClassPath() == null) {
			System.err.println("unable to generate output code, no activity reference");
			System.exit(-1);
		}
		String testClassPath = emitter.getApplicationClassPath() + Constants.Extensions.TEST;
		
		// generated test class name
		String testClassName = emitter.getApplicationClassName() + Constants.Extensions.TEST;
		String srcDirName = testClassName + File.separator + Constants.Dirs.SRC;
		String packageFilePath = srcDirName + File.separator + FileUtility.sourceDirectoryFromClassName(testClassPath);
		String templateFileName = testClassName + "." + Constants.Extensions.JAVA;
		// asset directory to write motion event files to
		String assetDirName = testClassName + File.separator + Constants.Dirs.ASSETS;
		
		// TODO: should change this variable
		int uniqueFileIndex = FileUtility.uniqueFileIndex(packageFilePath, templateFileName);
		if (uniqueFileIndex != 0) {
			testClassName += Integer.toString(uniqueFileIndex) ;
		}
		SetupRobotiumProject setupRobotiumProject = new SetupRobotiumProject();
		SetupRobotiumProject.Dirs dirs = setupRobotiumProject.new Dirs(testClassName, packageFilePath);

		if (emitter.getApplicationClassPath() != null) {
			
			// if no previous file was found, we're creating a project for the first time, and so we have to
			// make the directories, copy the build files, etc.  TODO:A much better test would be to check for the
			// project directory and use a flag.
			if (uniqueFileIndex == 0) {
				dirs.createDirectories();
				SetupRobotiumProject.writeBuildXML(testClassName, emitter.getApplicationClassPath());
				SetupRobotiumProject.copyBuildFiles(testClassName, projectPropertiesScan.getTarget());
				SetupRobotiumProject.copyLibraries(dirs.mLibDir);
				SetupRobotiumProject.writeManifest(testClassName, testClassName, testClassPath, emitter.getApplicationPackage());
				SetupRobotiumProject.copyTestDriverFile(packageFilePath, emitter.getApplicationClassPath() + Constants.Extensions.TEST);
				SetupRobotiumProject.writeResources(dirs, testClassName);
				if (fBinary) {
					SetupRobotiumProject.writeClasspathBinary(testClassName, Constants.Filenames.ROBOTIUM_JAR);
				} else {
					SetupRobotiumProject.writeClasspath(testClassName, targetProject, Constants.Filenames.ROBOTIUM_JAR);
				}
			}
		} else {
			System.err.println("no activity class specified");
		}
		
		writeInterstitialHandlers(emitter, outputCode, dirs, testClassPath);
		List<String> interstitialActivityHandlers = SetupRobotiumProject.getHandlerNames(dirs.mHandlerDir);
		List<String> interstitialActivities = SetupRobotiumProject.getHandlerActivityNames(dirs.mHandlerDir);
		// write the header template, the emitter output, and the trailer template.
		BufferedWriter bw = new BufferedWriter(new FileWriter(outputCodeFileName));
		emitter.writeHeader(emitter.getApplicationClassPath(), testClassPath, testClassName, 
							interstitialActivities, interstitialActivityHandlers, emitter.getApplicationClassName(), bw);
		if (options.mfWriteFunctions) {
			SplitFunction splitter = new SplitFunction(options.mMinLines);
			splitter.writeFunctions(bw, "test" + targetProject, 0, mainCode);
			emitter.writeClassTrailer(bw);
		} else {
			emitter.writeFunctionHeader(bw);
			emitter.writeLines(bw, mainCode);
			emitter.writeTrailer(bw);
		}
		
		bw.close();
		String androidSDK = System.getenv(Constants.Env.ANDROID_HOME);
		
		// save the sql, files, shared_prefs
		SaveState.saveStateFiles(androidSDK, testClassName + File.separator + Constants.Dirs.SAVESTATE, Constants.Dirs.EXTERNAL_STORAGE, emitter.getApplicationPackage());
		SetupRobotiumProject.writeMotionEvents(assetDirName, testClassName, motionEvents);
		SetupRobotiumProject.moveOutputCodeToPackage(packageFilePath, outputCodeFileName, testClassName);


	}
	
	public static void writeInterstitialHandlers(IEmitCode 								emitter,
											     Hashtable<String, List<LineAndTokens>> outputCode,  
											     SetupRobotiumProject.Dirs 				dirs,
											     String 								testClassPath) throws IOException {
	
		for (Entry<String, List<LineAndTokens>> entry : outputCode.entrySet()) {
			String activityClassName = entry.getKey();
			if (!activityClassName.equals(Constants.MAIN)) {
				String activityName = StringUtils.getNameFromClassPath(activityClassName);
				String interstitialHandlerName = Constants.INTERSTITIAL_ACTIVITY_HANDLER + activityName;
				String interstitialHandlerFile = dirs.mHandlerDir.getAbsolutePath() + File.separator + interstitialHandlerName + "." + Constants.Extensions.JAVA;
				List<LineAndTokens> code = entry.getValue();
				BufferedWriter bwHandler = new BufferedWriter(new OutputStreamWriter(new FileOutputStream(interstitialHandlerFile)));
				emitter.writeInterstitialHandler(bwHandler, testClassPath, interstitialHandlerName, code);
				bwHandler.close();
			}
		}
	}
	
	public EmitRobotiumCode() {
	}	
}
